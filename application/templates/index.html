{% extends "layout.html" %}
{% block content %}
<div class="site-header-logo">
    <h1 class="text-center" style="margin-top: 0rem;">Data Visualization</h1>
</div>

<div class="row p-4">
    <div class="card w-100 mx-auto" style="width: auto; height: auto; background-color: rgb(127, 255, 212);">
        <div class="d-flex justify-content-center mt-3">
            <label for="graphType" class="form-label me-2">Select Graph Type:</label>
            <select id="graphType" class="form-select" style="width: 200px;">
                <option value="3dScatter">Bathymetric/3D-Surface-ScatterPlot</option>
                <option value="2dScatter">Ocean Properties (2D Scatter Plot)</option>
            </select>
        </div>
        <div class="d-flex justify-content-center mt-3">
            <label for="colorScale" class="form-label me-2">Select Colorscale:</label>
            <select id="colorScale" class="form-select" style="width: 200px;">
                <option value="Viridis">Viridis</option>
                <option value="Plasma">Plasma</option>
                <option value="Cividis">Cividis</option>
                <option value="Inferno">Inferno</option>
                <option value="Magma">Magma</option>
            </select>
        </div>

        <ul class="nav nav-tabs mt-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">Upload CSV</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="select-tab" data-bs-toggle="tab" data-bs-target="#select" type="button" role="tab">Select File</button>
            </li>
        </ul>

        <div class="tab-content card-body">
            <!-- Tab 1: CSV Upload -->
            <div class="tab-pane fade show active" id="upload" role="tabpanel">
                <form action="/target" class="dropzone mt-4 border-dashed rounded-2 min-h-0" id="csv-dropzone"></form>
                <div class="d-flex justify-content-center">
                    <button id="plot-button-upload" class="btn btn-primary mt-3">Plot</button>
                </div>
            </div>

            <!-- Tab 2: File Selection -->
            <div class="tab-pane fade" id="select" role="tabpanel">
                <label for="fileSelector">Select a file:</label>
                <select id="fileSelector" class="form-select">
                    {% for name in fileNames %}
                        <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                </select>
                <button id="plot-button-select" class="btn btn-primary mt-3">Plot</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid p-4">
    <div class="row">
        <div class="col-12 col-md-10 offset-md-1">
            <div class="bg-light p-3 rounded shadow">
                <div id="plot-container" style="height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Plotly CDN -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let existingDropzone = Dropzone.forElement("#csv-dropzone");
    
        //properties
        existingDropzone.options.acceptedFiles = ".csv, text/csv, application/csv, application/vnd.ms-excel, text/x-csv, application/x-csv, text/comma-separated-values, text/x-comma-separated-values";
        existingDropzone.options.autoProcessQueue = false; // Disable automatic uploads
        existingDropzone.options.addRemoveLinks = true;
        existingDropzone.options.dictRemoveFile = "Remove";

        // for emulating loading bar when file is dropped in the dropzone
        existingDropzone.on("addedfile", function (file) {
            console.log(`CSV file added: ${file.name}`);
            
            let progress = 0;
            let interval = setInterval(() => {
                progress += 10;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    existingDropzone.emit("complete", file);
                }
                existingDropzone.emit("uploadprogress", file, progress);
            }, 50);

            let reader = new FileReader();
            reader.onload = function (event) {
                fileContent = event.target.result; // Store CSV content
                console.log(`File content loaded:\n${fileContent}`);
            };
            reader.readAsText(file); // Read file as text for CSV processing
        });
    
        existingDropzone.on("removedfile", function (file) {
            console.log(`File removed: ${file.name}`);
        });
    
        existingDropzone.on("error", function (file, message) {
            console.error(`Error with file: ${file.name}. Message: ${message}`);
        });
    });

    // Function to process CSV and generate the 3D scatter plot
    async function processAndPlot(fileContent, graphType, colorScale) {
        try {
            const rows = fileContent.trim().split("\n").map(row => row.split(","));
            if (rows.length < 2) {
                alert("CSV file must have at least two rows!");
                return;
            }

            const headers = rows[0];
            const data = rows.slice(1).filter(row => row.every(value => !isNaN(parseFloat(value))));
            const grouped = {};

            data.forEach(row => {
                const key = `${row[0]},${row[1]}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(parseFloat(row[2]));
            });

            const x = [], y = [], z = [];
            for (const key in grouped) {
                const [xi, yi] = key.split(",");
                const avgZ = grouped[key].reduce((a, b) => a + b, 0) / grouped[key].length;
                x.push(parseFloat(xi));
                y.push(parseFloat(yi));
                z.push(avgZ);
            }

            let traces;
            if (graphType === "3dScatter") {
                traces = [{
                    x, y, z,
                    mode: "markers",
                    type: "scatter3d",
                    marker: { size: 5, color: z, colorscale: colorScale },
                }];
            } else if (graphType === "2dScatter") {
                traces = [{
                    x, y,
                    mode: "markers",
                    type: "scatter",
                    marker: { size: 8, color: z, colorscale: colorScale },
                }];
            }

            Plotly.newPlot("plot-container", traces, { title: "Plotly Visualization" });
        } catch (error) {
            console.error("Error:", error);
            alert("Error processing the CSV file.");
        }
    }

    document.getElementById("plot-button-upload").addEventListener("click", async () => {
        const graphType = document.getElementById("graphType").value;
        const colorScale = document.getElementById("colorScale").value;

        if (!fileContent) {
            alert("Please add a CSV file first!");
            return;
        }
        await processAndPlot(fileContent, graphType, colorScale);
    });

    document.getElementById("plot-button-select").addEventListener("click", async () => {
        const graphType = document.getElementById("graphType").value;
        const colorScale = document.getElementById("colorScale").value;

        // Simulate fetching the file content
        const fileContent = "your file content from selected file logic here";
        await processAndPlot(fileContent, graphType, colorScale);
    });
</script>
<!--
<script src="../node_modules/dropzone/dist/min/dropzone.min.js"></script>
<script src="../assets/js/vendors/dropzone.js"></script>

<script>
// Drag-and-drop functionality
const dropZone = document.getElementById("dropZone");

dropZone.addEventListener("dragover", (event) => {
    event.preventDefault(); // Prevent default behavior to allow drop
    event.stopPropagation();
    dropZone.classList.add("drag-over"); // Add class to change border color
    //dropZone.style.borderColor = "green";
    console.log("Cursor is now over the drop-zone!");
});

dropZone.addEventListener("dragleave", (event) => {
    event.preventDefault();
    event.stopPropagation();
    dropZone.classList.remove("drag-over"); // Remove class to reset color
    console.log("Cursor is now away from drop-zone!");
});

dropZone.addEventListener("drop", (event) => {
    event.preventDefault();
    event.stopPropagation();
    dropZone.classList.remove("drag-over"); // Remove class after drop

    const file = event.dataTransfer.files[0];
    if (file && file.name.endsWith(".csv")) {
        console.log("CSV file dropped:", file.name);

        const reader = new FileReader();
        reader.onload = function (e) {
            const data = e.target.result;
            console.log("CSV file content loaded.");
            processCSVData(data, "chartContainerUpload");
        };
        reader.onerror = function () {
            console.error("Error reading file.");
        };
        reader.readAsText(file);
    } else {
        console.error("Only CSV files are supported.");
        alert("Please drop a valid .csv file.");
    }
});

// Function to process CSV data and plot
function processCSVData(csvData, containerId) {
    console.log("Processing CSV data for plotting...");

    // Parse the CSV data
    const rows = csvData.trim().split("\n").map(row => row.split(","));
    const headers = rows[0];
    const data = rows.slice(1).map(row => row.map(Number)); // Converting data rows to numbers

    if (data.length === 0 || data[0].length < 2) {
        console.error("Insufficient data to plot.");
        alert("The CSV file must have at least two columns of numeric data.");
        return;
    }

    // Assuming columns for x and y values
    const trace = {
        x: data.map(row => row[0]), // x values from first column
        y: data.map(row => row[1]), // y values from second column
        mode: "lines",
    };
    Plotly.newPlot(containerId, [trace]);
    console.log("Plot created successfully in", containerId);
}
</script>
-->
{% endblock %}
